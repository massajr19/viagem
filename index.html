<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TravelShopper AI v5.3</title>
    <link rel="icon" type="image/png" href="https://cdn-icons-png.flaticon.com/512/831/831145.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .hidden { display: none; }
        .tab-active { border-bottom: 4px solid #2563eb; color: #2563eb; font-size: 1.1rem; }
        @keyframes scanAnim { 0% { top: 0%; } 100% { top: 100%; } }
        .scan-line { position: absolute; width: 100%; height: 3px; background: #3b82f6; box-shadow: 0 0 20px #3b82f6; animation: scanAnim 2s linear infinite; }
        /* Ajuste global de acessibilidade */
        input, select, textarea { font-size: 16px !important; } /* Evita zoom autom√°tico no iOS e melhora leitura */
    </style>
</head>
<body class="p-4 bg-gray-100 font-sans pb-24">

    <header class="mb-6 bg-white p-5 rounded-3xl shadow-md border border-gray-200 flex justify-between items-center">
        <div class="flex items-center gap-3">
            <img src="https://cdn-icons-png.flaticon.com/512/831/831145.png" class="w-10 h-10">
            <h1 class="text-2xl font-black text-blue-600 tracking-tighter italic">TS AI</h1>
        </div>
        <div class="text-right">
            <select id="currencySelector" onchange="fetchExchangeRate()" class="p-2 border-2 border-blue-100 rounded-xl bg-gray-50 font-black text-sm outline-none shadow-sm">
                <option value="USD">D√≥lar ($)</option>
                <option value="EUR">Euro (‚Ç¨)</option>
                <option value="JPY">Iene (¬•)</option>
                <option value="QAR">Rial (Ô∑º)</option>
            </select>
            <p id="exchangeDisplay" class="text-[11px] text-gray-500 font-bold mt-1 uppercase"></p>
        </div>
    </header>

    <nav class="flex justify-around mb-6 bg-white rounded-2xl shadow-md p-3 text-xs font-black uppercase sticky top-2 z-50 border border-gray-100">
        <button id="btn-home" onclick="showPage('home')" class="py-2 px-3 text-gray-400 transition-all">Wishlist</button>
        <button id="btn-add" onclick="showPage('add')" class="py-2 px-3 text-gray-400 transition-all">Cadastrar IA</button>
        <button id="btn-scan" onclick="showPage('scan')" class="py-2 px-3 text-gray-400 transition-all">Comparar</button>
    </nav>

    <div id="page-home">
        <div id="wishlistContainer" class="space-y-4"></div>
    </div>

    <div id="page-add" class="hidden">
        <div class="relative bg-black w-full h-80 rounded-[2rem] mb-6 overflow-hidden shadow-2xl border-4 border-white">
            <video id="videoAdd" playsinline class="w-full h-full object-cover opacity-70"></video>
            <div class="scan-line"></div>
            <div class="absolute bottom-6 w-full flex justify-center">
                <button onclick="processImage('add')" class="bg-white p-5 rounded-full shadow-2xl active:scale-90 transition-transform border-4 border-blue-100">
                    <div class="w-14 h-14 bg-blue-600 rounded-full flex items-center justify-center text-white text-3xl font-bold">AI</div>
                </button>
            </div>
        </div>

        <div id="loadingAdd" class="hidden text-center p-4 bg-blue-600 text-white rounded-2xl mb-4 font-black text-sm animate-pulse">IA EST√Å LENDO O PRODUTO...</div>

        <div class="bg-white p-6 rounded-[2rem] shadow-xl space-y-4 border-t-8 border-blue-600">
            <div>
                <label class="text-xs font-black text-gray-400 uppercase ml-2">Nome do Produto</label>
                <input type="text" id="pName" placeholder="Ex: iPhone 16 Pro" class="w-full p-4 bg-gray-50 rounded-2xl border-2 border-gray-100 outline-none font-bold text-lg">
            </div>
            <div>
                <label class="text-xs font-black text-gray-400 uppercase ml-2 text-right block">Pre√ßo no Brasil (R$)</label>
                <input type="number" id="pPrice" placeholder="0.00" class="w-full p-5 bg-blue-50 rounded-2xl border-2 border-blue-100 font-black text-blue-700 text-3xl text-right">
            </div>
            <button onclick="saveProduct()" class="bg-blue-600 text-white w-full py-5 rounded-2xl font-black shadow-lg text-xl uppercase tracking-widest">Salvar na Lista</button>
        </div>
    </div>

    <div id="page-scan" class="hidden">
        <div class="relative bg-black w-full h-72 rounded-[2rem] mb-6 overflow-hidden shadow-2xl border-4 border-white">
            <video id="videoScan" playsinline class="w-full h-full object-cover"></video>
            <div class="absolute bottom-6 w-full flex justify-center">
                <button onclick="processImage('scan')" class="bg-white p-5 rounded-full shadow-2xl active:scale-95 transition-transform border-4 border-green-100">
                    <div class="w-14 h-14 bg-green-600 rounded-full flex items-center justify-center text-white text-3xl">üí∞</div>
                </button>
            </div>
        </div>

        <div id="loadingScan" class="hidden text-center p-4 bg-green-600 text-white rounded-2xl mb-4 font-black text-sm animate-pulse">IA LENDO PRE√áO NA ETIQUETA...</div>

        <div class="bg-white p-6 rounded-[2rem] shadow-xl space-y-4">
            <input type="text" id="scanName" list="products-list" placeholder="Qual produto?" class="w-full p-4 bg-gray-50 rounded-2xl border-2 border-gray-100 font-bold text-xl outline-none">
            <datalist id="products-list"></datalist>
            
            <div class="flex gap-3">
                <div class="flex-1">
                    <label class="text-[10px] font-black text-gray-400 uppercase block ml-2">Pre√ßo Local</label>
                    <input type="number" id="scanPrice" placeholder="0.00" class="w-full p-5 bg-gray-50 rounded-2xl text-3xl font-black text-blue-600 border-2 border-gray-100 outline-none">
                </div>
                <div class="w-28">
                    <label class="text-[10px] font-black text-gray-400 uppercase block">C√¢mbio</label>
                    <input type="number" id="exchangeRate" class="w-full p-5 border-2 border-gray-100 rounded-2xl font-black text-center text-lg bg-gray-100">
                </div>
            </div>
            <button onclick="comparePrice()" class="bg-blue-600 text-white w-full py-6 rounded-2xl font-black text-2xl shadow-xl italic tracking-tighter uppercase">Comparar</button>
        </div>
        <div id="resultArea" class="mt-6 p-8 rounded-[2rem] hidden shadow-2xl"></div>
    </div>

    <footer class="mt-12 text-center pb-12">
        <span class="bg-blue-600 text-white text-[12px] px-4 py-2 rounded-full font-black uppercase tracking-widest shadow-md">v5.3 - API ACTIVE</span>
    </footer>

    <script>
        // SUA CHAVE API INTEGRADA [Cuidado ao compartilhar este c√≥digo]
        const GEMINI_API_KEY = "AIzaSyDXrhxr9NMQp3D9SrVQzsQy9EyYNfIqXjU"; 
        
        let db = JSON.parse(localStorage.getItem('wishlist')) || [];
        let currentStream = null;

        async function fetchExchangeRate() {
            const currency = document.getElementById('currencySelector').value;
            const res = await fetch(`https://open.er-api.com/v6/latest/${currency}`);
            const data = await res.json();
            document.getElementById('exchangeRate').value = data.rates.BRL.toFixed(4);
            document.getElementById('exchangeDisplay').innerText = `1 ${currency} = R$ ${data.rates.BRL.toFixed(2)}`;
        }

        async function setupCamera(videoId) {
            if (currentStream) currentStream.getTracks().forEach(t => t.stop());
            try {
                currentStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
                document.getElementById(videoId).srcObject = currentStream;
                document.getElementById(videoId).play();
            } catch (e) { alert("Ajuste as permiss√µes de c√¢mera do Chrome!"); }
        }

        function showPage(page) {
            ['home', 'add', 'scan'].forEach(p => {
                document.getElementById(`page-${p}`).classList.toggle('hidden', page !== p);
                document.getElementById(`btn-${p}`).className = page === p ? 'py-2 px-3 tab-active' : 'py-2 px-3 text-gray-400';
            });
            if(page === 'add') setupCamera('videoAdd');
            else if(page === 'scan') setupCamera('videoScan');
            else if(currentStream) currentStream.getTracks().forEach(t => t.stop());
            if(page === 'home') renderWishlist();
            updateDatalist();
        }

        async function processImage(mode) {
            const video = document.getElementById(mode === 'add' ? 'videoAdd' : 'videoScan');
            const loader = document.getElementById(mode === 'add' ? 'loadingAdd' : 'loadingScan');
            loader.classList.remove('hidden');

            const canvas = document.createElement('canvas');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            canvas.getContext('2d').drawImage(video, 0, 0);
            const base64Image = canvas.toDataURL('image/jpeg').split(',')[1];

            const prompt = mode === 'add' 
                ? "Responda APENAS o nome comercial deste produto. Se for um medicamento ou cosm√©tico, use o nome da marca e o tipo. Ex: Bepantriz Derma."
                : "Extraia apenas os n√∫meros do pre√ßo desta etiqueta. Ignore s√≠mbolos de moeda. Ex: 99.90";

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${GEMINI_API_KEY}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: prompt }, { inline_data: { mime_type: "image/jpeg", data: base64Image } }] }]
                    })
                });
                const data = await response.json();
                const result = data.candidates[0].content.parts[0].text;

                if(mode === 'add') document.getElementById('pName').value = result.trim();
                else document.getElementById('scanPrice').value = result.replace(/[^0-
