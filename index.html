<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>TS AI ‚Äî Produtos & Compras</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .img-web { object-fit: contain; background: white; }
    .img-cam { object-fit: cover; background: #0f172a; } /* slate-900 */
    .safe-bottom { padding-bottom: env(safe-area-inset-bottom); }
  </style>
</head>

<body class="bg-slate-50 text-slate-900">
  <div class="max-w-5xl mx-auto px-4 pb-24">
    <!-- Top bar -->
    <header class="sticky top-0 z-40 bg-slate-50/90 backdrop-blur border-b border-slate-200">
      <div class="py-4 flex items-center justify-between gap-3">
        <div class="flex items-center gap-3">
          <div class="w-10 h-10 rounded-2xl bg-slate-900 text-white flex items-center justify-center font-bold">TS</div>
          <div>
            <div class="font-semibold leading-tight">TS AI</div>
            <div class="text-xs text-slate-500 -mt-0.5">Lista ‚Ä¢ Cadastro ‚Ä¢ Scan</div>
          </div>
        </div>

        <div class="flex items-center gap-2">
          <button id="btnSettings" class="px-3 py-2 rounded-xl border border-slate-200 bg-white hover:bg-slate-50 text-sm">
            Configura√ß√µes
          </button>
        </div>
      </div>

      <!-- Tabs -->
      <nav class="pb-3">
        <div class="grid grid-cols-3 gap-2">
          <button data-tab="list" class="tabBtn px-3 py-2 rounded-xl text-sm border border-slate-200 bg-white hover:bg-slate-50">LISTA</button>
          <button data-tab="add" class="tabBtn px-3 py-2 rounded-xl text-sm border border-slate-200 bg-white hover:bg-slate-50">CADASTRO</button>
          <button data-tab="scan" class="tabBtn px-3 py-2 rounded-xl text-sm border border-slate-200 bg-white hover:bg-slate-50">SCAN</button>
        </div>
      </nav>
    </header>

    <!-- LIST -->
    <section id="screen-list" class="pt-5">
      <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
        <div>
          <h1 class="text-xl font-semibold">Seus produtos</h1>
          <p class="text-sm text-slate-500">Salvos localmente (localStorage).</p>
        </div>

        <div class="flex items-center gap-2">
          <input id="listSearch" class="w-full sm:w-72 px-3 py-2 rounded-xl border border-slate-200 bg-white" placeholder="Buscar na lista‚Ä¶" />
          <button id="btnGoAdd" class="px-3 py-2 rounded-xl bg-slate-900 text-white hover:bg-slate-800 text-sm">
            + Adicionar
          </button>
        </div>
      </div>

      <div class="mt-4 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3" id="listGrid"></div>

      <div id="listEmpty" class="mt-6 hidden">
        <div class="p-6 rounded-2xl border border-dashed border-slate-300 bg-white text-center">
          <div class="text-lg font-semibold">Nenhum produto ainda</div>
          <div class="text-sm text-slate-500 mt-1">Toque em <b>Adicionar</b> para cadastrar o primeiro.</div>
        </div>
      </div>
    </section>

    <!-- ADD (Wizard) -->
    <section id="screen-add" class="pt-5 hidden">
      <!-- header -->
      <div class="flex items-start justify-between gap-3">
        <div>
          <h2 class="text-xl font-semibold" id="addTitle">Adicionar produto</h2>
          <p class="text-sm text-slate-500" id="addSubtitle">Escolha como voc√™ quer cadastrar.</p>
        </div>
        <button id="btnResetForm" class="px-3 py-2 rounded-xl border border-slate-200 bg-white hover:bg-slate-50 text-sm">
          Reiniciar
        </button>
      </div>

      <!-- step chips -->
      <div class="mt-3 flex flex-wrap gap-2">
        <span id="chipStep1" class="px-3 py-1.5 rounded-full text-xs border border-slate-200 bg-white">1) M√©todo</span>
        <span id="chipStep2" class="px-3 py-1.5 rounded-full text-xs border border-slate-200 bg-white">2) Capturar/Buscar</span>
        <span id="chipStep3" class="px-3 py-1.5 rounded-full text-xs border border-slate-200 bg-white">3) Revisar</span>
      </div>

      <!-- STEP 1: method -->
      <div id="addStep-method" class="mt-4">
        <div class="grid grid-cols-1 sm:grid-cols-3 gap-3">
          <button id="pickCamera" class="text-left p-4 rounded-2xl border border-slate-200 bg-white hover:shadow-sm transition">
            <div class="text-sm font-semibold">üì∑ Usar c√¢mera (IA)</div>
            <div class="text-sm text-slate-500 mt-1">Tire fotos do produto/etiqueta e deixe a IA preencher.</div>
          </button>

          <button id="pickShop" class="text-left p-4 rounded-2xl border border-slate-200 bg-white hover:shadow-sm transition">
            <div class="text-sm font-semibold">üîé Buscar na internet</div>
            <div class="text-sm text-slate-500 mt-1">Escolha um item pronto (pre√ßo pode depender do ML).</div>
          </button>

          <button id="pickManual" class="text-left p-4 rounded-2xl border border-slate-200 bg-white hover:shadow-sm transition">
            <div class="text-sm font-semibold">‚úçÔ∏è Cadastrar manualmente</div>
            <div class="text-sm text-slate-500 mt-1">Digite nome e pre√ßo. Depois voc√™ pode enriquecer.</div>
          </button>
        </div>

        <div class="mt-4 bg-white border border-slate-200 rounded-2xl p-4">
          <div class="text-sm font-semibold">Como esse app funciona?</div>
          <ul class="mt-2 text-sm text-slate-600 list-disc pl-5 space-y-1">
            <li>Voc√™ cadastra um produto com <b>pre√ßo no Brasil</b> (pra comparar).</li>
            <li>No <b>SCAN</b>, voc√™ digita (ou l√™ por foto) um pre√ßo em moeda estrangeira e compara.</li>
            <li>As buscas na internet passam por um <b>Worker proxy</b> (Configura√ß√µes).</li>
          </ul>
        </div>
      </div>

      <!-- STEP 2A: camera -->
      <div id="addStep-camera" class="mt-4 hidden">
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
          <div class="bg-white border border-slate-200 rounded-2xl p-4">
            <div class="flex items-start justify-between gap-3">
              <div>
                <div class="text-lg font-semibold">Fotos</div>
                <div class="text-sm text-slate-500">Tire 2‚Äì3 fotos (frente, etiqueta, pre√ßo). Depois toque em <b>Ler com IA</b>.</div>
              </div>
              <button id="btnClearPhotos" class="px-3 py-2 rounded-xl border border-slate-200 bg-white hover:bg-slate-50 text-sm">
                Apagar fotos
              </button>
            </div>

            <div class="mt-3 grid grid-cols-2 gap-2">
              <button id="btnStartCam" class="px-3 py-2 rounded-xl bg-slate-900 text-white hover:bg-slate-800 text-sm">Abrir c√¢mera</button>
              <button id="btnCapture" class="px-3 py-2 rounded-xl bg-amber-600 text-white hover:bg-amber-700 text-sm">Capturar</button>
              <button id="btnStopCam" class="px-3 py-2 rounded-xl border border-slate-200 bg-white hover:bg-slate-50 text-sm">Fechar c√¢mera</button>
              <button id="btnAIRead" class="px-3 py-2 rounded-xl bg-emerald-600 text-white hover:bg-emerald-700 text-sm">Ler com IA</button>
            </div>

            <div class="mt-3 rounded-2xl overflow-hidden border border-slate-200 bg-slate-900">
              <video id="camVideo" class="w-full h-56 hidden" playsinline autoplay></video>
              <img id="activePreview" class="w-full h-56 hidden" alt="preview" />
              <div id="previewPlaceholder" class="w-full h-56 flex items-center justify-center text-slate-300 text-sm">
                Nenhuma imagem ainda
              </div>
            </div>

            <div class="mt-3">
              <div class="text-xs font-medium text-slate-600">Miniaturas (toque para escolher a principal)</div>
              <div id="thumbs" class="mt-2 flex gap-2 overflow-x-auto pb-1"></div>
              <div class="mt-2 text-xs text-slate-500" id="primaryHint">Dica: a miniatura com ‚≠ê √© a imagem principal.</div>
            </div>

            <!-- Human-friendly AI status -->
            <div id="aiBox" class="mt-4 hidden">
              <div class="rounded-2xl border border-slate-200 bg-slate-50 p-3">
                <div class="flex items-center gap-2">
                  <div id="aiSpinner" class="w-4 h-4 rounded-full border-2 border-slate-300 border-t-slate-900 animate-spin"></div>
                  <div class="text-sm font-medium" id="aiTitle">Lendo imagem‚Ä¶</div>
                </div>
                <div class="text-sm text-slate-700 mt-1 whitespace-pre-wrap" id="aiMsg"></div>
                <div class="text-xs text-slate-500 mt-2" id="aiTip"></div>
              </div>
            </div>

            <!-- optional technical debug -->
            <details class="mt-4 rounded-2xl border border-slate-200 bg-white p-3">
              <summary class="cursor-pointer text-sm font-medium">Detalhes t√©cnicos (opcional)</summary>
              <pre id="aiDebug" class="mt-2 text-xs bg-slate-50 border border-slate-200 rounded-xl p-3 overflow-auto whitespace-pre-wrap"></pre>
            </details>
          </div>

          <div class="bg-white border border-slate-200 rounded-2xl p-4">
            <div class="text-lg font-semibold">Pr√©via dos dados</div>
            <div class="text-sm text-slate-500">Voc√™ poder√° revisar e ajustar antes de salvar.</div>

            <div class="mt-3 rounded-2xl border border-slate-200 overflow-hidden bg-white">
              <img id="productMainImage" class="w-full h-56 img-web" alt="imagem do produto" />
            </div>
            <div class="mt-2 text-xs text-slate-500">Fotos da c√¢mera usam <b>cover</b>; imagens da internet usam <b>contain</b>.</div>

            <div class="mt-4 grid grid-cols-1 gap-3">
              <div>
                <label class="text-xs font-medium text-slate-600">Nome do produto</label>
                <input id="pName" class="mt-1 w-full px-3 py-2 rounded-xl border border-slate-200 bg-white" placeholder="Ex: iPhone 15 Pro" />
              </div>
              <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                <div>
                  <label class="text-xs font-medium text-slate-600">Marca / fabricante</label>
                  <input id="pBrand" class="mt-1 w-full px-3 py-2 rounded-xl border border-slate-200 bg-white" placeholder="Ex: Apple" />
                </div>
                <div>
                  <label class="text-xs font-medium text-slate-600">Pre√ßo no Brasil (BRL)</label>
                  <input id="pPrice" type="number" step="0.01" class="mt-1 w-full px-3 py-2 rounded-xl border border-slate-200 bg-white" placeholder="Ex: 5999.90" />
                </div>
              </div>
            </div>

            <div class="mt-4 flex flex-col sm:flex-row gap-2">
              <button id="btnGoReviewFromCamera" class="px-4 py-2 rounded-xl bg-slate-900 text-white hover:bg-slate-800 text-sm font-medium">
                Continuar para revisar
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- STEP 2B: shopping -->
      <div id="addStep-shop" class="mt-4 hidden">
        <div class="bg-white border border-slate-200 rounded-2xl p-4">
          <div class="text-lg font-semibold">Buscar na internet</div>
          <div class="text-sm text-slate-500">Pesquise, selecione um item e depois revise.</div>

          <div class="mt-3 flex flex-col sm:flex-row gap-2">
            <input id="shopQuery" class="flex-1 px-3 py-2 rounded-xl border border-slate-200 bg-white" placeholder="Ex: iPhone 15 256gb" />
            <button id="btnShopSearch" class="px-4 py-2 rounded-xl bg-indigo-600 text-white hover:bg-indigo-700 text-sm font-medium">
              Buscar
            </button>
          </div>

          <div id="shopStatus" class="mt-3 hidden">
            <div class="rounded-2xl border border-slate-200 bg-slate-50 p-3 text-sm text-slate-700" id="shopStatusText"></div>
          </div>

          <div class="mt-3 grid grid-cols-1 gap-2" id="shopResults"></div>

          <details class="mt-4 rounded-2xl border border-slate-200 bg-white p-3">
            <summary class="cursor-pointer text-sm font-medium">Detalhes t√©cnicos (opcional)</summary>
            <pre id="netDebug" class="mt-2 text-xs bg-slate-50 border border-slate-200 rounded-xl p-3 overflow-auto whitespace-pre-wrap"></pre>
          </details>
        </div>
      </div>

      <!-- STEP 2C: manual -->
      <div id="addStep-manual" class="mt-4 hidden">
        <div class="bg-white border border-slate-200 rounded-2xl p-4">
          <div class="text-lg font-semibold">Cadastro manual</div>
          <div class="text-sm text-slate-500">Preencha o b√°sico. Voc√™ pode enriquecer depois.</div>

          <div class="mt-4 grid grid-cols-1 gap-3">
            <div>
              <label class="text-xs font-medium text-slate-600">Nome do produto</label>
              <input id="mName" class="mt-1 w-full px-3 py-2 rounded-xl border border-slate-200 bg-white" placeholder="Ex: AirPods Pro 2" />
            </div>
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
              <div>
                <label class="text-xs font-medium text-slate-600">Marca / fabricante (opcional)</label>
                <input id="mBrand" class="mt-1 w-full px-3 py-2 rounded-xl border border-slate-200 bg-white" placeholder="Ex: Apple" />
              </div>
              <div>
                <label class="text-xs font-medium text-slate-600">Pre√ßo no Brasil (BRL)</label>
                <input id="mPrice" type="number" step="0.01" class="mt-1 w-full px-3 py-2 rounded-xl border border-slate-200 bg-white" placeholder="Ex: 1799.90" />
              </div>
            </div>

            <button id="btnManualContinue" class="mt-2 px-4 py-2 rounded-xl bg-slate-900 text-white hover:bg-slate-800 text-sm font-medium">
              Continuar para revisar
            </button>
          </div>
        </div>
      </div>

      <!-- STEP 3: review + enrich + save -->
      <div id="addStep-review" class="mt-4 hidden">
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
          <div class="bg-white border border-slate-200 rounded-2xl p-4">
            <div class="flex items-start justify-between gap-3">
              <div>
                <div class="text-lg font-semibold">Revisar</div>
                <div class="text-sm text-slate-500">Ajuste os dados e escolha a imagem principal.</div>
              </div>
              <button id="btnBackToStep2" class="px-3 py-2 rounded-xl border border-slate-200 bg-white hover:bg-slate-50 text-sm">
                Voltar
              </button>
            </div>

            <div class="mt-3 rounded-2xl border border-slate-200 overflow-hidden bg-white">
              <img id="reviewImage" class="w-full h-56 img-web" alt="imagem principal" />
            </div>

            <div class="mt-3">
              <div class="text-xs font-medium text-slate-600">Miniaturas</div>
              <div id="reviewThumbs" class="mt-2 flex gap-2 overflow-x-auto pb-1"></div>
              <div class="mt-2 text-xs text-slate-500">Toque numa miniatura para definir como ‚≠ê principal.</div>
            </div>

            <div class="mt-4 grid grid-cols-1 gap-3">
              <div>
                <label class="text-xs font-medium text-slate-600">Nome do produto</label>
                <input id="rName" class="mt-1 w-full px-3 py-2 rounded-xl border border-slate-200 bg-white" />
              </div>

              <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                <div>
                  <label class="text-xs font-medium text-slate-600">Marca / fabricante</label>
                  <input id="rBrand" class="mt-1 w-full px-3 py-2 rounded-xl border border-slate-200 bg-white" />
                </div>
                <div>
                  <label class="text-xs font-medium text-slate-600">Pre√ßo no Brasil (BRL)</label>
                  <input id="rPrice" type="number" step="0.01" class="mt-1 w-full px-3 py-2 rounded-xl border border-slate-200 bg-white" />
                </div>
              </div>

              <details class="rounded-2xl border border-slate-200 bg-white p-3">
                <summary class="cursor-pointer text-sm font-medium">Detalhes (opcional)</summary>
                <div class="mt-3 space-y-3">
                  <div>
                    <label class="text-xs font-medium text-slate-600">Descri√ß√£o</label>
                    <textarea id="rDesc" rows="3" class="mt-1 w-full px-3 py-2 rounded-xl border border-slate-200 bg-white" placeholder="Descri√ß√£o do produto‚Ä¶"></textarea>
                  </div>
                  <div>
                    <label class="text-xs font-medium text-slate-600">Specs / dados t√©cnicos</label>
                    <textarea id="rSpecs" rows="4" class="mt-1 w-full px-3 py-2 rounded-xl border border-slate-200 bg-white" placeholder="Ex: 256GB, 6.1', A17 Pro‚Ä¶"></textarea>
                  </div>
                </div>
              </details>
            </div>

            <div class="mt-4 flex flex-col sm:flex-row gap-2">
              <button id="btnEnrich" class="px-4 py-2 rounded-xl bg-slate-900 text-white hover:bg-slate-800 text-sm font-medium">
                Buscar na internet (enrich)
              </button>
              <button id="btnLookupML" class="px-4 py-2 rounded-xl border border-slate-200 bg-white hover:bg-slate-50 text-sm font-medium">
                Tentar pre√ßo (Mercado Livre)
              </button>
            </div>

            <!-- Enrich status -->
            <div id="enrichBox" class="mt-4 hidden">
              <div class="rounded-2xl border border-slate-200 bg-slate-50 p-3">
                <div class="flex items-center gap-2">
                  <div id="enrichSpinner" class="w-4 h-4 rounded-full border-2 border-slate-300 border-t-slate-900 animate-spin"></div>
                  <div class="text-sm font-medium" id="enrichTitle">Processando‚Ä¶</div>
                </div>
                <div class="text-sm text-slate-700 mt-1 whitespace-pre-wrap" id="enrichMsg"></div>
                <div class="mt-2 text-xs text-slate-500" id="enrichSources"></div>
              </div>
            </div>
          </div>

          <div class="bg-white border border-slate-200 rounded-2xl p-4">
            <div class="text-lg font-semibold">Salvar</div>
            <div class="text-sm text-slate-500">Quando estiver tudo certo, salve o produto.</div>

            <div class="mt-4 rounded-2xl border border-dashed border-slate-300 bg-slate-50 p-4">
              <div class="text-sm text-slate-700">
                ‚úÖ Dica: Se a IA n√£o pegar tudo, isso √© normal. Voc√™ pode corrigir aqui e salvar.
              </div>
              <div class="text-sm text-slate-700 mt-2">
                ‚ö†Ô∏è Mercado Livre pode bloquear (403). Nesse caso, o pre√ßo fica manual e o app continua.
              </div>
            </div>

            <button id="btnSave" class="mt-4 w-full px-4 py-3 rounded-2xl bg-emerald-600 text-white hover:bg-emerald-700 text-sm font-semibold">
              Salvar produto
            </button>

            <details class="mt-4 rounded-2xl border border-slate-200 bg-white p-3">
              <summary class="cursor-pointer text-sm font-medium">Detalhes t√©cnicos (opcional)</summary>
              <pre id="reviewDebug" class="mt-2 text-xs bg-slate-50 border border-slate-200 rounded-xl p-3 overflow-auto whitespace-pre-wrap"></pre>
            </details>
          </div>
        </div>
      </div>
    </section>

    <!-- SCAN -->
    <section id="screen-scan" class="pt-5 hidden">
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
        <div class="bg-white border border-slate-200 rounded-2xl p-4">
          <div class="flex items-start justify-between gap-3">
            <div>
              <h2 class="text-lg font-semibold">SCAN</h2>
              <p class="text-sm text-slate-500">Compare um pre√ßo em moeda estrangeira com o pre√ßo no Brasil.</p>
            </div>
            <button id="btnScanClear" class="px-3 py-2 rounded-xl border border-slate-200 bg-white hover:bg-slate-50 text-sm">
              Limpar
            </button>
          </div>

          <div class="mt-4 grid grid-cols-1 sm:grid-cols-2 gap-3">
            <div class="sm:col-span-2">
              <label class="text-xs font-medium text-slate-600">Produto (da sua lista)</label>
              <select id="scanProduct" class="mt-1 w-full px-3 py-2 rounded-xl border border-slate-200 bg-white"></select>
            </div>

            <div>
              <label class="text-xs font-medium text-slate-600">Moeda</label>
              <select id="scanCurrency" class="mt-1 w-full px-3 py-2 rounded-xl border border-slate-200 bg-white">
                <option value="USD">USD</option>
                <option value="EUR">EUR</option>
                <option value="JPY">JPY</option>
                <option value="QAR">QAR</option>
              </select>
            </div>

            <div>
              <label class="text-xs font-medium text-slate-600">C√¢mbio (BRL)</label>
              <div class="mt-1 flex gap-2">
                <input id="scanRate" type="number" step="0.0001" class="flex-1 px-3 py-2 rounded-xl border border-slate-200 bg-slate-50" readonly />
                <button id="btnRate" class="px-3 py-2 rounded-xl border border-slate-200 bg-white hover:bg-slate-50 text-sm">
                  Atualizar
                </button>
              </div>
            </div>

            <div class="sm:col-span-2">
              <label class="text-xs font-medium text-slate-600">Pre√ßo local (na moeda escolhida)</label>
              <input id="scanLocalPrice" type="number" step="0.01" class="mt-1 w-full px-3 py-2 rounded-xl border border-slate-200 bg-white" placeholder="Ex: 999.99" />
            </div>
          </div>

          <div class="mt-4 flex flex-col sm:flex-row gap-2">
            <button id="btnScanCalc" class="px-4 py-2 rounded-xl bg-slate-900 text-white hover:bg-slate-800 text-sm font-medium">
              Comparar
            </button>
            <button id="btnScanAIRead" class="px-4 py-2 rounded-xl bg-emerald-600 text-white hover:bg-emerald-700 text-sm font-medium">
              Ler pre√ßo por foto (IA)
            </button>
          </div>

          <!-- human-friendly scan AI status -->
          <div id="scanAiBox" class="mt-4 hidden">
            <div class="rounded-2xl border border-slate-200 bg-slate-50 p-3">
              <div class="flex items-center gap-2">
                <div id="scanAiSpinner" class="w-4 h-4 rounded-full border-2 border-slate-300 border-t-slate-900 animate-spin"></div>
                <div class="text-sm font-medium" id="scanAiTitle">Lendo imagem‚Ä¶</div>
              </div>
              <div class="text-sm text-slate-700 mt-1 whitespace-pre-wrap" id="scanAiMsg"></div>
              <div class="text-xs text-slate-500 mt-2" id="scanAiTip"></div>
            </div>
          </div>

          <div id="scanResult" class="mt-4 hidden">
            <div class="rounded-2xl border border-slate-200 bg-slate-50 p-4">
              <div class="text-sm text-slate-600">Resultado</div>
              <div class="mt-1 text-2xl font-semibold" id="scanVerdict">‚Äî</div>
              <div class="mt-2 text-sm text-slate-700 whitespace-pre-wrap" id="scanDetails"></div>
            </div>
          </div>

          <details class="mt-4 rounded-2xl border border-slate-200 bg-white p-3">
            <summary class="cursor-pointer text-sm font-medium">Detalhes t√©cnicos (opcional)</summary>
            <pre id="scanAiDebug" class="mt-2 text-xs bg-slate-50 border border-slate-200 rounded-xl p-3 overflow-auto whitespace-pre-wrap"></pre>
          </details>
        </div>

        <!-- scan photos -->
        <div class="bg-white border border-slate-200 rounded-2xl p-4">
          <div class="flex items-start justify-between gap-3">
            <div>
              <h3 class="font-semibold">Fotos do pre√ßo</h3>
              <p class="text-sm text-slate-500">Tire 2‚Äì3 fotos da etiqueta/tela de pre√ßo. A IA tenta em sequ√™ncia.</p>
            </div>
            <button id="btnScanClearPhotos" class="px-3 py-2 rounded-xl border border-slate-200 bg-white hover:bg-slate-50 text-sm">
              Apagar fotos
            </button>
          </div>

          <div class="mt-3 grid grid-cols-2 gap-2">
            <button id="btnScanStartCam" class="px-3 py-2 rounded-xl bg-slate-900 text-white hover:bg-slate-800 text-sm">Abrir c√¢mera</button>
            <button id="btnScanCapture" class="px-3 py-2 rounded-xl bg-amber-600 text-white hover:bg-amber-700 text-sm">Capturar</button>
            <button id="btnScanStopCam" class="px-3 py-2 rounded-xl border border-slate-200 bg-white hover:bg-slate-50 text-sm">Fechar c√¢mera</button>
            <button id="btnScanUseActive" class="px-3 py-2 rounded-xl bg-indigo-600 text-white hover:bg-indigo-700 text-sm">Escolher foto ativa</button>
          </div>

          <div class="mt-3 rounded-2xl overflow-hidden border border-slate-200 bg-slate-900">
            <video id="scanCamVideo" class="w-full h-56 hidden" playsinline autoplay></video>
            <img id="scanActivePreview" class="w-full h-56 hidden" alt="preview" />
            <div id="scanPreviewPlaceholder" class="w-full h-56 flex items-center justify-center text-slate-300 text-sm">
              Nenhuma imagem ainda
            </div>
          </div>

          <div class="mt-3">
            <div class="text-xs font-medium text-slate-600">Miniaturas</div>
            <div id="scanThumbs" class="mt-2 flex gap-2 overflow-x-auto pb-1"></div>
            <div class="mt-2 text-xs text-slate-500">Toque numa miniatura para definir como ativa (‚≠ê).</div>
          </div>
        </div>
      </div>
    </section>
  </div>

  <!-- SETTINGS MODAL -->
  <div id="settingsModal" class="fixed inset-0 hidden z-50">
    <div class="absolute inset-0 bg-black/40"></div>
    <div class="absolute inset-0 flex items-end sm:items-center justify-center p-3">
      <div class="w-full max-w-xl bg-white rounded-2xl border border-slate-200 shadow-xl overflow-hidden">
        <div class="p-4 border-b border-slate-200 flex items-start justify-between gap-3">
          <div>
            <div class="text-lg font-semibold">Configura√ß√µes</div>
            <div class="text-sm text-slate-500">Gemini + Worker proxy</div>
          </div>
          <button id="btnCloseSettings" class="px-3 py-2 rounded-xl border border-slate-200 bg-white hover:bg-slate-50 text-sm">Fechar</button>
        </div>

        <div class="p-4 space-y-4">
          <div>
            <label class="text-xs font-medium text-slate-600">Worker base URL</label>
            <input id="workerUrl" class="mt-1 w-full px-3 py-2 rounded-xl border border-slate-200 bg-white" placeholder="Ex: https://seu-worker.seudominio.workers.dev" />
            <div class="mt-1 text-xs text-slate-500">Usado para /health, /enrich, /search, /details, /lookup.</div>
          </div>

          <div>
            <label class="text-xs font-medium text-slate-600">Gemini API Key</label>
            <input id="geminiKey" type="password" class="mt-1 w-full px-3 py-2 rounded-xl border border-slate-200 bg-white" placeholder="Cole sua API key" />
            <div class="mt-1 text-xs text-slate-500">A key fica salva localmente no seu navegador.</div>
          </div>

          <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 items-end">
            <div>
              <label class="text-xs font-medium text-slate-600">Modelo Gemini</label>
              <select id="geminiModel" class="mt-1 w-full px-3 py-2 rounded-xl border border-slate-200 bg-white"></select>
            </div>
            <button id="btnListModels" class="px-4 py-2 rounded-xl bg-slate-900 text-white hover:bg-slate-800 text-sm font-medium">
              Listar modelos
            </button>
          </div>

          <div class="rounded-2xl border border-slate-200 bg-slate-50 p-3">
            <div class="text-sm font-medium">Teste r√°pido</div>
            <div class="mt-2 flex flex-col sm:flex-row gap-2">
              <button id="btnHealth" class="px-3 py-2 rounded-xl border border-slate-200 bg-white hover:bg-slate-50 text-sm">/health</button>
              <button id="btnSaveSettings" class="px-3 py-2 rounded-xl bg-emerald-600 text-white hover:bg-emerald-700 text-sm">Salvar</button>
            </div>
            <div class="mt-2 text-xs text-slate-600 whitespace-pre-wrap" id="settingsStatus"></div>
          </div>

          <details class="rounded-2xl border border-slate-200 bg-white p-3">
            <summary class="cursor-pointer text-sm font-medium">Debug (Modelos)</summary>
            <pre id="modelsDebug" class="mt-2 text-xs bg-slate-50 border border-slate-200 rounded-xl p-3 overflow-auto whitespace-pre-wrap"></pre>
          </details>
        </div>
      </div>
    </div>
  </div>

<script>
/* =========================
   TS AI ‚Äî Wizard UX (mobile-first)
   Mudan√ßas principais:
   - Cadastro virou um fluxo em 3 passos (M√©todo -> Capturar/Buscar -> Revisar)
   - Feedback humano para IA (sem depender de Debug)
   - Escolha expl√≠cita da imagem principal (capturar n√£o troca a principal se voc√™ j√° escolheu)
   - Enrich e ML continuam funcionando e ficam na etapa Revisar
   ========================= */

/* ---------- Compat: localStorage keys antigas ---------- */
const LS_KEYS = {
  products: ["tsai_products", "products", "TS_PRODUCTS", "ts_products"],
  geminiKey: ["tsai_gemini_key", "geminiKey", "TS_GEMINI_KEY"],
  geminiModel: ["tsai_gemini_model", "geminiModel", "TS_GEMINI_MODEL"],
  workerUrl: ["tsai_worker_url", "workerBase", "workerUrl", "TS_WORKER_URL"]
};

function lsGetAny(keys, fallback="") {
  for (const k of keys) {
    const v = localStorage.getItem(k);
    if (v !== null && v !== undefined && v !== "") return v;
  }
  return fallback;
}
function lsSetPrimary(keys, value) {
  localStorage.setItem(keys[0], value);
}

/* ---------- Estado ---------- */
let products = [];
let activeTab = "list";

let camStream = null;
let scanCamStream = null;

// fotos (dataURL)
const addPhotos = { images: [], activeIndex: -1 };
const scanPhotos = { images: [], activeIndex: -1 };

// imagem web (URL)
let webImageUrl = "";

// wizard state
const addFlow = {
  step: 1, // 1 method, 2 capture/search/manual, 3 review
  mode: null, // "camera" | "shop" | "manual"
  editingId: null // quando abre item da lista
};

/* ---------- Util ---------- */
const $ = (id) => document.getElementById(id);

function moneyBRL(v) {
  const n = Number(v);
  if (!isFinite(n)) return "R$ ‚Äî";
  return n.toLocaleString("pt-BR", { style: "currency", currency: "BRL" });
}
function clampText(s, max=120) {
  s = (s || "").trim();
  if (s.length <= max) return s;
  return s.slice(0, max-1) + "‚Ä¶";
}
function isDataUrl(src) { return typeof src === "string" && src.startsWith("data:image/"); }

function setSmartImage(imgEl, src) {
  if (!imgEl) return;
  const safe = src || "";
  imgEl.src = safe || "";
  imgEl.classList.remove("img-web", "img-cam");
  if (!safe) { imgEl.classList.add("img-web"); return; }
  if (isDataUrl(safe)) imgEl.classList.add("img-cam");
  else imgEl.classList.add("img-web");
}

function escapeHtml(s) {
  return (s ?? "").toString()
    .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
    .replaceAll('"',"&quot;").replaceAll("'","&#039;");
}
function escapeAttr(s) { return escapeHtml(s).replaceAll("`","&#096;"); }

function uid() { return Math.random().toString(16).slice(2) + "-" + Date.now().toString(16); }
function nowISO() { return new Date().toISOString(); }

/* ---------- Worker ---------- */
function workerBase() { return (lsGetAny(LS_KEYS.workerUrl, "") || "").replace(/\/+$/,""); }
async function workerGet(path) {
  const base = workerBase();
  if (!base) throw new Error("Worker URL n√£o configurada (Configura√ß√µes).");
  const url = base + path;
  const r = await fetch(url);
  const txt = await r.text();
  let json = null;
  try { json = JSON.parse(txt); } catch {}
  return { ok: r.ok, status: r.status, text: txt, json };
}

/* ---------- Gemini ---------- */
function geminiKey() { return lsGetAny(LS_KEYS.geminiKey, ""); }
function geminiModel() { return lsGetAny(LS_KEYS.geminiModel, ""); }

async function geminiListModels() {
  const key = geminiKey();
  if (!key) throw new Error("Gemini API Key n√£o configurada.");
  const url = "https://generativelanguage.googleapis.com/v1beta/models?key=" + encodeURIComponent(key);
  const r = await fetch(url);
  return await r.json();
}

async function geminiGenerateFromImage(dataUrl, prompt) {
  const key = geminiKey();
  const model = geminiModel();
  if (!key) throw new Error("Gemini API Key n√£o configurada.");
  if (!model) throw new Error("Modelo Gemini n√£o selecionado.");
  const base64 = (dataUrl || "").split(",")[1] || "";
  const url = `https://generativelanguage.googleapis.com/v1beta/models/${encodeURIComponent(model)}:generateContent?key=${encodeURIComponent(key)}`;
  const body = {
    contents: [{
      role: "user",
      parts: [
        { text: prompt },
        { inline_data: { mime_type: "image/jpeg", data: base64 } }
      ]
    }]
  };
  const r = await fetch(url, { method:"POST", headers:{ "Content-Type":"application/json" }, body: JSON.stringify(body) });
  const raw = await r.text();
  let json = null;
  try { json = JSON.parse(raw); } catch {}
  return { ok: r.ok, status: r.status, raw, json };
}

function extractGeminiText(respJson) {
  try {
    const parts = respJson?.candidates?.[0]?.content?.parts || [];
    return parts.map(p => p.text).filter(Boolean).join("\n").trim();
  } catch { return ""; }
}

function safeJsonParse(maybeText) {
  const t = (maybeText || "").trim();
  let s = t.replace(/```json/gi, "```").trim();
  if (s.startsWith("```")) s = s.replace(/^```/, "").replace(/```$/, "").trim();
  const first = s.indexOf("{");
  const last = s.lastIndexOf("}");
  if (first !== -1 && last !== -1 && last > first) {
    const slice = s.slice(first, last+1);
    try { return JSON.parse(slice); } catch {}
  }
  try { return JSON.parse(s); } catch {}
  return null;
}

function fallbackFromText(text) {
  const t = (text || "").replace(/\s+/g," ").trim();
  let name = t ? t.slice(0, 60) : "";
  const m = t.match(/(\d{1,3}(\.\d{3})+|\d+)([.,]\d{2})/);
  let p = 0;
  if (m) {
    const raw = m[0].replace(/\./g,"").replace(",",".");
    const n = Number(raw);
    if (isFinite(n)) p = n;
  }
  return { n: name || "", p: p || 0 };
}

const AI_PROMPT_PRODUCT = `
Voc√™ √© um extrator de dados. Retorne APENAS um JSON v√°lido, sem markdown, sem explica√ß√µes.
Formato exato:
{"n":"NOME_DO_PRODUTO","p":0}
Regras:
- "n" √© uma string curta.
- "p" √© um n√∫mero (use ponto como separador decimal). Se n√£o houver pre√ßo vis√≠vel, use 0.
- Se houver moeda estrangeira na imagem, ignore o s√≠mbolo e retorne apenas o n√∫mero.
`.trim();

/* ---------- Human status boxes ---------- */
function showAIBox(title, msg, spinning=true, tip="") {
  $("aiBox").classList.remove("hidden");
  $("aiTitle").textContent = title || "Processando‚Ä¶";
  $("aiMsg").textContent = msg || "";
  $("aiSpinner").classList.toggle("hidden", !spinning);
  $("aiTip").textContent = tip || "";
}
function hideAIBox() { $("aiBox").classList.add("hidden"); }

function showScanAIBox(title, msg, spinning=true, tip="") {
  $("scanAiBox").classList.remove("hidden");
  $("scanAiTitle").textContent = title || "Processando‚Ä¶";
  $("scanAiMsg").textContent = msg || "";
  $("scanAiSpinner").classList.toggle("hidden", !spinning);
  $("scanAiTip").textContent = tip || "";
}
function hideScanAIBox() { $("scanAiBox").classList.add("hidden"); }

function showEnrichBox(title, msg, spinning=true, sources=[]) {
  $("enrichBox").classList.remove("hidden");
  $("enrichTitle").textContent = title || "Processando‚Ä¶";
  $("enrichMsg").textContent = msg || "";
  $("enrichSpinner").classList.toggle("hidden", !spinning);

  if (Array.isArray(sources) && sources.length) {
    const html = sources.map(s => {
      const u = s?.url || "";
      const n = s?.name || "Fonte";
      if (!u) return `<span class="inline-block mr-2">${escapeHtml(n)}</span>`;
      return `<a class="underline text-slate-700 hover:text-slate-900 inline-block mr-2" href="${escapeAttr(u)}" target="_blank" rel="noopener noreferrer">${escapeHtml(n)}</a>`;
    }).join("");
    $("enrichSources").innerHTML = `<div><span class="text-slate-500">Fontes:</span> ${html}</div>`;
  } else {
    $("enrichSources").innerHTML = "";
  }
}
function hideEnrichBox() { $("enrichBox").classList.add("hidden"); }

/* ---------- Tabs ---------- */
function setTab(tab) {
  activeTab = tab;
  for (const s of ["list","add","scan"]) $("screen-"+s).classList.toggle("hidden", s !== tab);

  document.querySelectorAll(".tabBtn").forEach(b => {
    const on = b.dataset.tab === tab;
    b.classList.toggle("bg-slate-900", on);
    b.classList.toggle("text-white", on);
    b.classList.toggle("border-slate-900", on);
    b.classList.toggle("bg-white", !on);
  });

  if (tab === "list") renderList();
  if (tab === "scan") refreshScanProducts();
  if (tab === "add") renderAddWizard();
}

/* ---------- Products storage ---------- */
function loadProducts() {
  const raw = lsGetAny(LS_KEYS.products, "[]");
  try { products = Array.isArray(JSON.parse(raw)) ? JSON.parse(raw) : []; }
  catch { products = []; }
  lsSetPrimary(LS_KEYS.products, JSON.stringify(products));
}
function saveProducts() { lsSetPrimary(LS_KEYS.products, JSON.stringify(products)); }

function productMainSrc(p) {
  return p?.img || p?.image || (Array.isArray(p?.imgs) ? p.imgs[0] : "") || "";
}

/* ---------- List render ---------- */
function renderList() {
  const q = ($("listSearch").value || "").trim().toLowerCase();
  const grid = $("listGrid");
  grid.innerHTML = "";

  const filtered = products.filter(p => {
    if (!q) return true;
    const hay = `${p.name||""} ${p.brand||""} ${p.desc||""}`.toLowerCase();
    return hay.includes(q);
  });

  $("listEmpty").classList.toggle("hidden", filtered.length !== 0);

  filtered
    .sort((a,b)=> (b.updatedAt||b.createdAt||"").localeCompare(a.updatedAt||a.createdAt||""))
    .forEach(p => {
      const card = document.createElement("div");
      card.className = "rounded-2xl border border-slate-200 bg-white overflow-hidden hover:shadow-sm transition";

      card.innerHTML = `
        <div class="h-40 bg-white border-b border-slate-200">
          <img class="w-full h-full" alt="img" />
        </div>
        <div class="p-3">
          <div class="flex items-start justify-between gap-2">
            <div class="font-semibold leading-tight">${escapeHtml(p.name || "‚Äî")}</div>
            <div class="text-sm font-semibold">${moneyBRL(p.priceBRL)}</div>
          </div>
          <div class="text-xs text-slate-500 mt-1">${escapeHtml(p.brand || "")}</div>
          <div class="text-xs text-slate-600 mt-2">${escapeHtml(clampText(p.desc || "", 110))}</div>
          <div class="mt-3 flex gap-2">
            <button data-act="edit" class="flex-1 px-3 py-2 rounded-xl bg-slate-900 text-white hover:bg-slate-800 text-sm">Abrir</button>
            <button data-act="del" class="px-3 py-2 rounded-xl border border-slate-200 bg-white hover:bg-slate-50 text-sm">Excluir</button>
          </div>
        </div>
      `;

      setSmartImage(card.querySelector("img"), productMainSrc(p));

      card.querySelector('[data-act="edit"]').onclick = () => openProductInWizard(p.id);
      card.querySelector('[data-act="del"]').onclick = () => {
        if (!confirm("Excluir este produto?")) return;
        products = products.filter(x => x.id !== p.id);
        saveProducts();
        renderList();
        refreshScanProducts();
      };

      grid.appendChild(card);
    });
}

/* ---------- Wizard: reset & navigation ---------- */
function resetWizard() {
  addFlow.step = 1;
  addFlow.mode = null;
  addFlow.editingId = null;

  // clear shared fields
  $("pName").value = "";
  $("pBrand").value = "";
  $("pPrice").value = "";
  $("mName").value = "";
  $("mBrand").value = "";
  $("mPrice").value = "";

  webImageUrl = "";
  addPhotos.images = [];
  addPhotos.activeIndex = -1;

  $("reviewDebug").textContent = "";
  $("aiDebug").textContent = "";
  hideAIBox();
  hideEnrichBox();

  stopStream(camStream); camStream = null;
  $("camVideo").classList.add("hidden");

  renderAddWizard();
}

function setStep(step, mode=null) {
  if (mode) addFlow.mode = mode;
  addFlow.step = step;
  renderAddWizard();
}

function renderAddWizard() {
  // update chip highlight
  const chip = (id, on) => {
    const el = $(id);
    el.classList.toggle("bg-slate-900", on);
    el.classList.toggle("text-white", on);
    el.classList.toggle("border-slate-900", on);
  };
  chip("chipStep1", addFlow.step === 1);
  chip("chipStep2", addFlow.step === 2);
  chip("chipStep3", addFlow.step === 3);

  // title/subtitle
  const modeLabel = addFlow.mode === "camera" ? "C√¢mera (IA)" : addFlow.mode === "shop" ? "Internet" : addFlow.mode === "manual" ? "Manual" : "";
  $("addTitle").textContent = addFlow.editingId ? "Editar produto" : "Adicionar produto";

  if (addFlow.step === 1) $("addSubtitle").textContent = "Escolha como voc√™ quer cadastrar.";
  if (addFlow.step === 2) $("addSubtitle").textContent = modeLabel ? `Passo 2 ‚Äî ${modeLabel}` : "Passo 2 ‚Äî Capturar/Buscar";
  if (addFlow.step === 3) $("addSubtitle").textContent = "Passo 3 ‚Äî Revisar e salvar.";

  // show/hide steps
  $("addStep-method").classList.toggle("hidden", addFlow.step !== 1);
  $("addStep-camera").classList.toggle("hidden", !(addFlow.step === 2 && addFlow.mode === "camera"));
  $("addStep-shop").classList.toggle("hidden", !(addFlow.step === 2 && addFlow.mode === "shop"));
  $("addStep-manual").classList.toggle("hidden", !(addFlow.step === 2 && addFlow.mode === "manual"));
  $("addStep-review").classList.toggle("hidden", addFlow.step !== 3);

  // refresh photo UIs
  if (addFlow.step === 2 && addFlow.mode === "camera") {
    renderAddPhotosUI();
    setMainImageFromState();
  }

  if (addFlow.step === 3) {
    syncReviewFromCurrent();
    renderReviewThumbs();
    setReviewImageFromState();
  }
}

/* ---------- Photos UI (Cadastro) ---------- */
function setMainImageFromState() {
  let src = "";
  if (addPhotos.activeIndex >= 0 && addPhotos.images[addPhotos.activeIndex]) src = addPhotos.images[addPhotos.activeIndex];
  else if (webImageUrl) src = webImageUrl;
  setSmartImage($("productMainImage"), src);
}
function renderAddPhotosUI() {
  const thumbs = $("thumbs");
  thumbs.innerHTML = "";

  const hasActive = addPhotos.activeIndex >= 0 && addPhotos.images[addPhotos.activeIndex];
  const activeSrc = hasActive ? addPhotos.images[addPhotos.activeIndex] : "";

  $("previewPlaceholder").classList.toggle("hidden", !!activeSrc || $("camVideo").classList.contains("hidden")==false);
  $("activePreview").classList.toggle("hidden", !activeSrc);

  if (activeSrc) {
    $("activePreview").src = activeSrc;
    setSmartImage($("activePreview"), activeSrc);
  }

  addPhotos.images.forEach((src, idx) => {
    const btn = document.createElement("button");
    const isActive = idx === addPhotos.activeIndex;
    btn.className = "relative shrink-0 w-16 h-16 rounded-2xl overflow-hidden border " + (isActive ? "border-slate-900" : "border-slate-200");
    btn.innerHTML = `
      <img class="w-full h-full" alt="thumb">
      ${isActive ? `<div class="absolute top-1 left-1 text-[10px] bg-slate-900 text-white px-1.5 py-0.5 rounded-full">‚≠ê</div>` : ``}
    `;
    setSmartImage(btn.querySelector("img"), src);

    btn.onclick = () => {
      addPhotos.activeIndex = idx;
      renderAddPhotosUI();
      setMainImageFromState();
    };
    thumbs.appendChild(btn);
  });
}

/* ---------- Camera helpers ---------- */
async function startCamera(preferEnvironment=true) {
  const constraints = { video: { facingMode: preferEnvironment ? { ideal: "environment" } : "user" }, audio:false };
  return await navigator.mediaDevices.getUserMedia(constraints);
}
function stopStream(stream) { if (stream) stream.getTracks().forEach(t => t.stop()); }
function captureFromVideo(videoEl) {
  const canvas = document.createElement("canvas");
  const w = videoEl.videoWidth || 1280;
  const h = videoEl.videoHeight || 720;
  canvas.width = w; canvas.height = h;
  canvas.getContext("2d").drawImage(videoEl, 0, 0, w, h);
  return canvas.toDataURL("image/jpeg", 0.85);
}

/* ---------- IA: tenta fotos em sequ√™ncia (com feedback humano) ---------- */
async function aiTryImagesSequential(images, debugEl, onProgress) {
  if (!Array.isArray(images) || images.length === 0) throw new Error("Nenhuma foto dispon√≠vel.");
  const prompt = AI_PROMPT_PRODUCT;

  let combinedText = "";
  for (let i = 0; i < images.length; i++) {
    onProgress?.(i, images.length);
    debugEl.textContent += `\n[IA] Tentando foto ${i+1}/${images.length}‚Ä¶\n`;

    let resp;
    try {
      resp = await geminiGenerateFromImage(images[i], prompt);
    } catch (e) {
      debugEl.textContent += `Erro ao chamar Gemini: ${e.message}\n`;
      continue;
    }

    debugEl.textContent += `Status: ${resp.status}\nRAW:\n${resp.raw}\n`;

    if (!resp.ok || !resp.json) continue;

    const text = extractGeminiText(resp.json) || "";
    combinedText += "\n" + text;

    const parsed = safeJsonParse(text);
    if (parsed && typeof parsed === "object") {
      const n = (parsed.n ?? parsed.name ?? "").toString().trim();
      const p = Number(parsed.p ?? parsed.price ?? 0);
      if (n || (isFinite(p) && p > 0)) {
        return { ok:true, n: n || "", p: isFinite(p) ? p : 0, rawText: text, full: resp.json };
      }
    }
  }

  const fb = fallbackFromText(combinedText);
  return { ok:true, n: fb.n || "", p: fb.p || 0, rawText: combinedText, full:null, fallback:true };
}

/* ---------- Review: sync ---------- */
function getCurrentDraft() {
  // draft principal vem do wizard (pName/pBrand/pPrice quando c√¢mera; mName/mBrand/mPrice quando manual; review fields quando j√° no review)
  const name =
    ($("rName")?.value || "").trim() ||
    ($("pName")?.value || "").trim() ||
    ($("mName")?.value || "").trim();

  const brand =
    ($("rBrand")?.value || "").trim() ||
    ($("pBrand")?.value || "").trim() ||
    ($("mBrand")?.value || "").trim();

  const price =
    Number(($("rPrice")?.value || "").trim() || $("pPrice")?.value || $("mPrice")?.value || 0);

  const desc = ($("rDesc")?.value || "").trim();
  const specs = ($("rSpecs")?.value || "").trim();

  return { name, brand, priceBRL: isFinite(price) ? price : 0, desc, specs };
}

function syncReviewFromCurrent() {
  // preenche review com a melhor fonte dispon√≠vel (sem destruir o que j√° foi editado no review)
  const d = getCurrentDraft();

  if (!$("rName").value.trim()) $("rName").value = d.name || "";
  if (!$("rBrand").value.trim()) $("rBrand").value = d.brand || "";
  if (!$("rPrice").value.trim() && d.priceBRL) $("rPrice").value = d.priceBRL;

  // se est√° vindo de c√¢mera/manual e review est√° vazio, carregue
  if (!$("rDesc").value.trim()) $("rDesc").value = d.desc || "";
  if (!$("rSpecs").value.trim()) $("rSpecs").value = d.specs || "";
}

function setReviewImageFromState() {
  let src = "";
  if (addPhotos.activeIndex >= 0 && addPhotos.images[addPhotos.activeIndex]) src = addPhotos.images[addPhotos.activeIndex];
  else if (webImageUrl) src = webImageUrl;
  setSmartImage($("reviewImage"), src);
}

function renderReviewThumbs() {
  const box = $("reviewThumbs");
  box.innerHTML = "";

  // c√¢mera thumbs
  addPhotos.images.forEach((src, idx) => {
    const isActive = idx === addPhotos.activeIndex;
    const btn = document.createElement("button");
    btn.className = "relative shrink-0 w-16 h-16 rounded-2xl overflow-hidden border " + (isActive ? "border-slate-900" : "border-slate-200");
    btn.innerHTML = `
      <img class="w-full h-full" alt="thumb">
      ${isActive ? `<div class="absolute top-1 left-1 text-[10px] bg-slate-900 text-white px-1.5 py-0.5 rounded-full">‚≠ê</div>` : ``}
    `;
    setSmartImage(btn.querySelector("img"), src);
    btn.onclick = () => { addPhotos.activeIndex = idx; renderReviewThumbs(); setReviewImageFromState(); setMainImageFromState(); };
    box.appendChild(btn);
  });

  // web image as extra thumb (if exists)
  if (webImageUrl) {
    const isWebActive = addPhotos.activeIndex < 0; // se nenhuma foto ativa, web √© "principal"
    const btn = document.createElement("button");
    btn.className = "relative shrink-0 w-16 h-16 rounded-2xl overflow-hidden border " + (isWebActive ? "border-slate-900" : "border-slate-200");
    btn.innerHTML = `
      <img class="w-full h-full img-web" alt="webthumb">
      ${isWebActive ? `<div class="absolute top-1 left-1 text-[10px] bg-slate-900 text-white px-1.5 py-0.5 rounded-full">‚≠ê</div>` : ``}
    `;
    const img = btn.querySelector("img");
    img.classList.add("img-web");
    setSmartImage(img, webImageUrl);

    btn.onclick = () => {
      addPhotos.activeIndex = -1; // escolher web como principal
      renderReviewThumbs();
      setReviewImageFromState();
      setMainImageFromState();
    };
    box.appendChild(btn);
  }

  setReviewImageFromState();
}

/* ---------- Enrich / Lookup ML (na etapa Revisar) ---------- */
async function doEnrich() {
  const q = ($("rName").value || "").trim() || ($("pName").value || "").trim() || ($("mName").value || "").trim();
  if (!q) { showEnrichBox("Ops", "Preencha o nome do produto antes de buscar.", false); return; }

  try {
    showEnrichBox("Buscando na internet‚Ä¶", "Consultando Wikipedia/Wikidata e tentando enriquecer dados‚Ä¶", true);
    $("reviewDebug").textContent = "";
    const r = await workerGet(`/enrich?q=${encodeURIComponent(q)}&lang=pt`);
    $("reviewDebug").textContent += `GET /enrich\nStatus: ${r.status}\nRaw:\n${r.text}\n`;

    if (!r.ok || !r.json) { showEnrichBox("Falha no enrich", "N√£o consegui interpretar a resposta do Worker.", false); return; }

    if (r.json.ok && r.json.found) {
      if (r.json.description && !$("rDesc").value.trim()) $("rDesc").value = r.json.description;
      if (r.json.specs && !$("rSpecs").value.trim()) $("rSpecs").value = r.json.specs;
      if ((r.json.brand || r.json.manufacturer) && !$("rBrand").value.trim()) $("rBrand").value = (r.json.brand || r.json.manufacturer);

      if (r.json.image) { webImageUrl = r.json.image; renderReviewThumbs(); setMainImageFromState(); }

      if (r.json.priceBRL && (!Number($("rPrice").value) || Number($("rPrice").value) <= 0)) {
        $("rPrice").value = Number(r.json.priceBRL);
      }

      const sources = Array.isArray(r.json.sources) ? r.json.sources : [];
      showEnrichBox("Enrich conclu√≠do ‚úÖ", "Dados preenchidos quando dispon√≠veis.", false, sources);
    } else {
      showEnrichBox("Nada encontrado", "N√£o encontrei dados suficientes para enriquecer. Voc√™ pode completar manualmente.", false);
    }
  } catch (e) {
    showEnrichBox("Erro", e.message || String(e), false);
  }
}

async function doLookupML() {
  const q = ($("rName").value || "").trim();
  if (!q) { showEnrichBox("Ops", "Preencha o nome do produto antes de tentar o Mercado Livre.", false); return; }

  try {
    showEnrichBox("Mercado Livre‚Ä¶", "Tentando buscar pre√ßo no Mercado Livre (pode bloquear).", true);
    const r = await workerGet(`/lookup?q=${encodeURIComponent(q)}&site=MLB`);
    $("reviewDebug").textContent += `\nGET /lookup\nStatus: ${r.status}\nRaw:\n${r.text}\n`;

    if (!r.json) { showEnrichBox("Falha", "Resposta do Worker n√£o √© JSON.", false); return; }

    if (r.json.ok && r.json.item && r.json.item.priceBRL) {
      $("rPrice").value = Number(r.json.item.priceBRL);
      showEnrichBox("Pre√ßo encontrado ‚úÖ", `Pre√ßo (BRL) preenchido: ${moneyBRL(r.json.item.priceBRL)}`, false);
      return;
    }

    if (r.json.error === "ml_blocked" || r.status === 403) {
      showEnrichBox("ML bloqueou (ok)", "Mercado Livre bloqueou no Worker. Siga com pre√ßo manual ‚Äî o app n√£o trava.", false);
      return;
    }

    showEnrichBox("Sem pre√ßo", "N√£o consegui obter pre√ßo por aqui. Siga com pre√ßo manual.", false);
  } catch (e) {
    showEnrichBox("Erro", e.message || String(e), false);
  }
}

/* ---------- Shopping mode ---------- */
function renderShopResults(items, note="") {
  const box = $("shopResults");
  box.innerHTML = "";
  $("shopStatus").classList.toggle("hidden", !note);
  $("shopStatusText").textContent = note || "";

  (items || []).forEach(it => {
    const row = document.createElement("div");
    row.className = "rounded-2xl border border-slate-200 bg-white p-3 flex gap-3 items-start hover:shadow-sm transition";

    row.innerHTML = `
      <div class="w-16 h-16 rounded-2xl overflow-hidden border border-slate-200 bg-white shrink-0">
        <img class="w-full h-full img-web" alt="img">
      </div>
      <div class="flex-1 min-w-0">
        <div class="text-sm font-semibold leading-tight">${escapeHtml(it.title || it.name || "‚Äî")}</div>
        <div class="text-xs text-slate-500 mt-1">${escapeHtml(it.source || it.provider || "")}</div>
        <div class="text-sm font-semibold mt-2">${it.priceBRL ? moneyBRL(it.priceBRL) : "<span class='text-slate-500'>Pre√ßo indispon√≠vel</span>"}</div>
        <div class="mt-2 flex gap-2">
          <button class="btnPick px-3 py-2 rounded-xl bg-indigo-600 text-white hover:bg-indigo-700 text-sm">Selecionar</button>
          ${it.url ? `<a class="px-3 py-2 rounded-xl border border-slate-200 bg-white hover:bg-slate-50 text-sm" href="${escapeAttr(it.url)}" target="_blank" rel="noopener noreferrer">Abrir</a>` : ""}
        </div>
      </div>
    `;

    const img = row.querySelector("img");
    setSmartImage(img, it.thumbnail || it.image || "");
    img.classList.remove("img-cam"); img.classList.add("img-web");

    row.querySelector(".btnPick").onclick = async () => {
      try {
        $("shopStatus").classList.remove("hidden");
        $("shopStatusText").textContent = "Carregando detalhes do item‚Ä¶";
        $("reviewDebug").textContent = "";

        // clear photo principal selection to prefer web image (until user picks camera photo later)
        addPhotos.activeIndex = -1;

        if (it.id) {
          const r = await workerGet(`/details?id=${encodeURIComponent(it.id)}`);
          $("reviewDebug").textContent += `GET /details\nStatus: ${r.status}\nRaw:\n${r.text}\n`;

          if (r.json?.ok && r.json.item) {
            const d = r.json.item;
            $("rName").value = d.title || it.title || "";
            $("rBrand").value = d.brand || d.manufacturer || "";
            if (d.priceBRL) $("rPrice").value = Number(d.priceBRL);
            if (d.specs) $("rSpecs").value = d.specs;
            if (Array.isArray(d.images) && d.images.length) webImageUrl = d.images[0];
            else if (it.thumbnail) webImageUrl = it.thumbnail;
          } else {
            $("rName").value = it.title || "";
            if (it.priceBRL) $("rPrice").value = Number(it.priceBRL);
            if (it.thumbnail) webImageUrl = it.thumbnail;
          }
        } else {
          $("rName").value = it.title || "";
          if (it.priceBRL) $("rPrice").value = Number(it.priceBRL);
          if (it.thumbnail) webImageUrl = it.thumbnail;
        }

        // vai para review
        setStep(3);
        renderReviewThumbs();
        setReviewImageFromState();

        // enrich autom√°tico (sem travar)
        $("shopStatusText").textContent = "Enriquecendo com Wikipedia/Wikidata‚Ä¶";
        await doEnrich();
        $("shopStatusText").textContent = "Pronto ‚úÖ (revise e salve)";
      } catch (e) {
        $("shopStatus").classList.remove("hidden");
        $("shopStatusText").textContent = "Erro: " + (e.message || String(e));
      }
    };

    box.appendChild(row);
  });
}

async function doShopSearch() {
  const q = ($("shopQuery").value || "").trim();
  if (!q) { renderShopResults([], "Digite um termo de busca."); return; }
  try {
    $("shopStatus").classList.remove("hidden");
    $("shopStatusText").textContent = "Buscando itens‚Ä¶";
    $("reviewDebug").textContent = "";

    const r = await workerGet(`/search?q=${encodeURIComponent(q)}&site=MLB&limit=10`);
    $("reviewDebug").textContent += `GET /search\nStatus: ${r.status}\nRaw:\n${r.text}\n`;

    const items = r.json?.items || [];
    let note = "";
    if (r.json?.fallback) note = "Fallback (sem pre√ßo) ‚Äî Mercado Livre pode ter bloqueado.";
    if (!items.length) note = note || "Nenhum item retornado.";
    renderShopResults(items, note);
  } catch (e) {
    renderShopResults([], "Erro: " + (e.message || String(e)));
  }
}

/* ---------- Save (from review) ---------- */
function saveFromReview() {
  const name = ($("rName").value || "").trim();
  const brand = ($("rBrand").value || "").trim();
  const priceBRL = Number($("rPrice").value || 0);
  const desc = ($("rDesc").value || "").trim();
  const specs = ($("rSpecs").value || "").trim();

  if (!name) { alert("Preencha ao menos o nome do produto."); return; }

  let mainImg = "";
  if (addPhotos.activeIndex >= 0 && addPhotos.images[addPhotos.activeIndex]) mainImg = addPhotos.images[addPhotos.activeIndex];

  const p = {
    id: addFlow.editingId || uid(),
    name,
    brand,
    priceBRL: isFinite(priceBRL) ? priceBRL : 0,
    desc,
    specs,
    img: mainImg || "",
    imgs: [...addPhotos.images],
    image: webImageUrl || "",
    updatedAt: nowISO()
  };

  if (!addFlow.editingId) p.createdAt = nowISO();
  else {
    const old = products.find(x => x.id === addFlow.editingId);
    if (old?.createdAt) p.createdAt = old.createdAt;
  }

  const idx = products.findIndex(x => x.id === p.id);
  if (idx >= 0) products[idx] = p;
  else products.unshift(p);

  saveProducts();
  renderList();
  refreshScanProducts();

  alert("Salvo ‚úÖ");
  setTab("list");
}

/* ---------- Open existing product in wizard ---------- */
function openProductInWizard(id) {
  const p = products.find(x => x.id === id);
  if (!p) return;

  resetWizard();
  addFlow.editingId = id;

  // carregar campos no review
  $("rName").value = p.name || "";
  $("rBrand").value = p.brand || "";
  $("rPrice").value = (p.priceBRL ?? "").toString();
  $("rDesc").value = p.desc || "";
  $("rSpecs").value = p.specs || "";

  addPhotos.images = Array.isArray(p.imgs) ? [...p.imgs] : (p.img ? [p.img] : []);
  addPhotos.activeIndex = addPhotos.images.length ? 0 : -1;

  webImageUrl = p.image && !isDataUrl(p.image) ? p.image : "";

  setTab("add");
  setStep(3); // direto para revisar
}

/* ---------- SCAN ---------- */
async function fetchRate(currency) {
  const url = `https://open.er-api.com/v6/latest/${encodeURIComponent(currency)}`;
  const r = await fetch(url);
  const j = await r.json();
  if (j?.result !== "success" || !j?.rates?.BRL) throw new Error("Falha ao obter c√¢mbio.");
  return Number(j.rates.BRL);
}
async function updateScanRate() {
  try {
    $("btnRate").disabled = true;
    const c = $("scanCurrency").value;
    $("scanRate").value = await fetchRate(c);
  } catch (e) {
    alert("Erro c√¢mbio: " + (e.message || String(e)));
  } finally {
    $("btnRate").disabled = false;
  }
}
function refreshScanProducts() {
  const sel = $("scanProduct");
  sel.innerHTML = "";
  if (!products.length) {
    const op = document.createElement("option");
    op.value = "";
    op.textContent = "Nenhum produto cadastrado";
    sel.appendChild(op);
    return;
  }
  products.forEach(p => {
    const op = document.createElement("option");
    op.value = p.id;
    op.textContent = `${p.name} ‚Äî ${moneyBRL(p.priceBRL)}`;
    sel.appendChild(op);
  });
}
function scanClearAll() {
  $("scanLocalPrice").value = "";
  $("scanResult").classList.add("hidden");
  $("scanVerdict").textContent = "‚Äî";
  $("scanDetails").textContent = "";
  $("scanAiDebug").textContent = "";
  hideScanAIBox();

  $("scanCurrency").value = "USD";
  $("scanRate").value = "";

  scanPhotos.images = [];
  scanPhotos.activeIndex = -1;
  renderScanPhotosUI();

  updateScanRate();
}
function scanCompare() {
  const pid = $("scanProduct").value;
  const p = products.find(x => x.id === pid);
  if (!p) { alert("Selecione um produto."); return; }

  const local = Number($("scanLocalPrice").value || 0);
  const rate = Number($("scanRate").value || 0);
  if (!local || !rate) { alert("Preencha o pre√ßo local e garanta o c√¢mbio."); return; }

  const brlConverted = local * rate;
  const brPrice = Number(p.priceBRL || 0);
  const diff = brlConverted - brPrice;

  const verdict = (brPrice > 0 && brlConverted < brPrice) ? "VALE ‚úÖ" : "CARO ‚ö†Ô∏è";
  $("scanVerdict").textContent = verdict;

  const c = $("scanCurrency").value;
  $("scanDetails").textContent =
`Produto: ${p.name}
Pre√ßo BR: ${moneyBRL(brPrice)}
Pre√ßo local: ${local.toLocaleString("pt-BR")} ${c}
C√¢mbio: 1 ${c} = ${rate.toLocaleString("pt-BR")} BRL
Convertido: ${moneyBRL(brlConverted)}
Diferen√ßa: ${moneyBRL(diff)} (${diff < 0 ? "mais barato" : "mais caro"})`;

  $("scanResult").classList.remove("hidden");
}

/* ---------- SCAN photos UI ---------- */
function renderScanPhotosUI() {
  const thumbs = $("scanThumbs");
  thumbs.innerHTML = "";

  const hasActive = scanPhotos.activeIndex >= 0 && scanPhotos.images[scanPhotos.activeIndex];
  const activeSrc = hasActive ? scanPhotos.images[scanPhotos.activeIndex] : "";

  $("scanPreviewPlaceholder").classList.toggle("hidden", !!activeSrc || $("scanCamVideo").classList.contains("hidden")==false);
  $("scanActivePreview").classList.toggle("hidden", !activeSrc);

  if (activeSrc) {
    $("scanActivePreview").src = activeSrc;
    setSmartImage($("scanActivePreview"), activeSrc);
  }

  scanPhotos.images.forEach((src, idx) => {
    const isActive = idx === scanPhotos.activeIndex;
    const btn = document.createElement("button");
    btn.className = "relative shrink-0 w-16 h-16 rounded-2xl overflow-hidden border " + (isActive ? "border-slate-900" : "border-slate-200");
    btn.innerHTML = `
      <img class="w-full h-full" alt="thumb">
      ${isActive ? `<div class="absolute top-1 left-1 text-[10px] bg-slate-900 text-white px-1.5 py-0.5 rounded-full">‚≠ê</div>` : ``}
    `;
    setSmartImage(btn.querySelector("img"), src);
    btn.onclick = () => { scanPhotos.activeIndex = idx; renderScanPhotosUI(); };
    thumbs.appendChild(btn);
  });
}

/* ---------- Settings modal ---------- */
function openSettings(show) {
  $("settingsModal").classList.toggle("hidden", !show);
  $("settingsStatus").textContent = "";
}
function hydrateModelSelect(selected) {
  const sel = $("geminiModel");
  const current = selected || "";
  const defaults = ["gemini-1.5-flash","gemini-1.5-pro","gemini-2.0-flash","gemini-2.0-pro"];
  sel.innerHTML = "";
  const opt0 = document.createElement("option");
  opt0.value = ""; opt0.textContent = "‚Äî selecione ‚Äî";
  sel.appendChild(opt0);
  defaults.forEach(m => {
    const o = document.createElement("option");
    o.value = m; o.textContent = m;
    if (m === current) o.selected = true;
    sel.appendChild(o);
  });
  if (current && !defaults.includes(current)) {
    const o = document.createElement("option");
    o.value = current; o.textContent = current; o.selected = true;
    sel.appendChild(o);
  }
}
function saveSettings() {
  lsSetPrimary(LS_KEYS.workerUrl, ($("workerUrl").value || "").trim());
  lsSetPrimary(LS_KEYS.geminiKey, ($("geminiKey").value || "").trim());
  lsSetPrimary(LS_KEYS.geminiModel, ($("geminiModel").value || "").trim());
  $("settingsStatus").textContent = "Salvo ‚úÖ";
}
async function listModelsUI() {
  try {
    $("modelsDebug").textContent = "";
    $("settingsStatus").textContent = "Listando modelos‚Ä¶";
    const j = await geminiListModels();
    $("modelsDebug").textContent = JSON.stringify(j, null, 2);

    const models = (j.models || [])
      .filter(m => Array.isArray(m.supportedGenerationMethods) && m.supportedGenerationMethods.includes("generateContent"))
      .map(m => m.name?.replace(/^models\//,""))
      .filter(Boolean);

    const sel = $("geminiModel");
    const current = sel.value || lsGetAny(LS_KEYS.geminiModel, "");
    sel.innerHTML = "";
    const opt0 = document.createElement("option");
    opt0.value = ""; opt0.textContent = "‚Äî selecione ‚Äî";
    sel.appendChild(opt0);
    models.forEach(m => {
      const o = document.createElement("option");
      o.value = m; o.textContent = m;
      if (m === current) o.selected = true;
      sel.appendChild(o);
    });

    $("settingsStatus").textContent = `Modelos carregados ‚úÖ (${models.length})`;
  } catch (e) {
    $("settingsStatus").textContent = "Erro: " + (e.message || String(e));
  }
}
async function healthCheck() {
  try {
    $("settingsStatus").textContent = "Chamando /health‚Ä¶";
    const r = await workerGet("/health");
    $("settingsStatus").textContent = `Status: ${r.status}\n${r.text}`;
  } catch (e) {
    $("settingsStatus").textContent = "Erro: " + (e.message || String(e));
  }
}

/* ---------- Wiring ---------- */
function init() {
  loadProducts();
  renderList();
  refreshScanProducts();
  updateScanRate();

  // tabs
  document.querySelectorAll(".tabBtn").forEach(b => b.onclick = () => setTab(b.dataset.tab));
  setTab("list");

  // list
  $("btnGoAdd").onclick = () => { resetWizard(); setTab("add"); };
  $("listSearch").oninput = renderList;

  // reset wizard button
  $("btnResetForm").onclick = resetWizard;

  // pick method
  $("pickCamera").onclick = () => { setStep(2, "camera"); };
  $("pickShop").onclick = () => { setStep(2, "shop"); };
  $("pickManual").onclick = () => { setStep(2, "manual"); };

  // camera step
  $("btnStartCam").onclick = async () => {
    try {
      if (camStream) return;
      camStream = await startCamera(true);
      $("camVideo").srcObject = camStream;
      $("camVideo").classList.remove("hidden");
      $("activePreview").classList.add("hidden");
      $("previewPlaceholder").classList.add("hidden");
    } catch (e) {
      alert("Erro c√¢mera: " + (e.message || String(e)));
    }
  };

  $("btnStopCam").onclick = () => {
    stopStream(camStream); camStream = null;
    $("camVideo").classList.add("hidden");
    renderAddPhotosUI();
  };

  // IMPORTANT: capturar N√ÉO muda a principal se voc√™ j√° escolheu uma
  $("btnCapture").onclick = () => {
    if (!camStream) { alert("Abra a c√¢mera primeiro."); return; }
    const dataUrl = captureFromVideo($("camVideo"));
    addPhotos.images.push(dataUrl); // mant√©m ordem (primeira foto tende a ser "principal")
    if (addPhotos.activeIndex < 0) addPhotos.activeIndex = 0; // s√≥ define principal se ainda n√£o houver
    renderAddPhotosUI();
    setMainImageFromState();
  };

  $("btnClearPhotos").onclick = () => {
    addPhotos.images = [];
    addPhotos.activeIndex = -1;
    renderAddPhotosUI();
    setMainImageFromState();
  };

  $("btnAIRead").onclick = async () => {
    try {
      $("aiDebug").textContent = "";
      hideAIBox();
      if (!addPhotos.images.length) { alert("Tire ao menos 1 foto."); return; }

      showAIBox("Lendo imagens‚Ä¶", "Vou tentar identificar nome e pre√ßo. Isso pode levar alguns segundos.", true, "Dica: foque no texto e evite reflexo.");
      const res = await aiTryImagesSequential(addPhotos.images, $("aiDebug"), (i,total) => {
        showAIBox("Lendo imagens‚Ä¶", `Tentando foto ${i+1} de ${total}‚Ä¶`, true, "Se falhar, tente tirar a foto mais de perto e com boa luz.");
      });

      // preencher campos do passo c√¢mera
      if (res.n && !$("pName").value.trim()) $("pName").value = res.n;
      if (res.p && (!Number($("pPrice").value) || Number($("pPrice").value) <= 0)) $("pPrice").value = res.p;

      if (res.n || res.p) {
        showAIBox("‚úÖ Pronto!", "Encontrei informa√ß√µes. Revise os campos e continue para revisar.", false, res.fallback ? "Alguns dados podem ter sido aproximados ‚Äî confira antes de salvar." : "");
      } else {
        showAIBox("‚ö†Ô∏è N√£o encontrei tudo", "N√£o consegui identificar nome/pre√ßo com seguran√ßa. Voc√™ pode preencher manualmente e continuar.", false, "Dica: tire uma foto bem n√≠tida da etiqueta/pre√ßo.");
      }
    } catch (e) {
      showAIBox("‚ùå Erro ao ler", e.message || String(e), false, "Confira se a API Key e o modelo Gemini est√£o configurados em Configura√ß√µes.");
      $("aiDebug").textContent += "\nERRO: " + (e.message || String(e)) + "\n";
    }
  };

  $("btnGoReviewFromCamera").onclick = () => {
    // levar valores do passo c√¢mera para review (sem duplicar confus√£o)
    if (!$("rName").value.trim()) $("rName").value = ($("pName").value || "").trim();
    if (!$("rBrand").value.trim()) $("rBrand").value = ($("pBrand").value || "").trim();
    if (!$("rPrice").value.trim()) $("rPrice").value = ($("pPrice").value || "").trim();
    setStep(3);
  };

  // manual step
  $("btnManualContinue").onclick = () => {
    $("rName").value = ($("mName").value || "").trim();
    $("rBrand").value = ($("mBrand").value || "").trim();
    $("rPrice").value = ($("mPrice").value || "").trim();
    setStep(3);
  };

  // shopping
  $("btnShopSearch").onclick = doShopSearch;
  $("shopQuery").addEventListener("keydown", (e) => { if (e.key === "Enter") doShopSearch(); });

  // review
  $("btnBackToStep2").onclick = () => setStep(2, addFlow.mode || "manual");
  $("btnEnrich").onclick = doEnrich;
  $("btnLookupML").onclick = doLookupML;
  $("btnSave").onclick = saveFromReview;

  // scan
  $("btnRate").onclick = updateScanRate;
  $("scanCurrency").onchange = updateScanRate;
  $("btnScanCalc").onclick = scanCompare;
  $("btnScanClear").onclick = scanClearAll;

  // scan camera
  $("btnScanStartCam").onclick = async () => {
    try {
      if (scanCamStream) return;
      scanCamStream = await startCamera(true);
      $("scanCamVideo").srcObject = scanCamStream;
      $("scanCamVideo").classList.remove("hidden");
      $("scanActivePreview").classList.add("hidden");
      $("scanPreviewPlaceholder").classList.add("hidden");
    } catch (e) {
      alert("Erro c√¢mera: " + (e.message || String(e)));
    }
  };
  $("btnScanStopCam").onclick = () => {
    stopStream(scanCamStream); scanCamStream = null;
    $("scanCamVideo").classList.add("hidden");
    renderScanPhotosUI();
  };
  $("btnScanCapture").onclick = () => {
    if (!scanCamStream) { alert("Abra a c√¢mera primeiro."); return; }
    const dataUrl = captureFromVideo($("scanCamVideo"));
    scanPhotos.images.push(dataUrl);
    if (scanPhotos.activeIndex < 0) scanPhotos.activeIndex = 0; // s√≥ define se n√£o houver ativa
    renderScanPhotosUI();
  };
  $("btnScanClearPhotos").onclick = () => {
    scanPhotos.images = [];
    scanPhotos.activeIndex = -1;
    renderScanPhotosUI();
  };
  $("btnScanUseActive").onclick = () => {
    if (scanPhotos.activeIndex < 0) { alert("Selecione uma foto (miniatura)."); return; }
    alert("Foto ativa selecionada ‚úÖ");
  };

  $("btnScanAIRead").onclick = async () => {
    try {
      $("scanAiDebug").textContent = "";
      hideScanAIBox();
      if (!scanPhotos.images.length) { alert("Tire ao menos 1 foto no painel √† direita."); return; }

      showScanAIBox("Lendo imagens‚Ä¶", "Vou tentar identificar o pre√ßo na etiqueta/tela.", true, "Dica: enquadre apenas a √°rea do pre√ßo.");
      const res = await aiTryImagesSequential(scanPhotos.images, $("scanAiDebug"), (i,total) => {
        showScanAIBox("Lendo imagens‚Ä¶", `Tentando foto ${i+1} de ${total}‚Ä¶`, true, "Se falhar, aproxime e melhore a ilumina√ß√£o.");
      });

      if (res.p && res.p > 0) {
        $("scanLocalPrice").value = res.p;
        showScanAIBox("‚úÖ Pre√ßo encontrado", `Preenchi o pre√ßo local com: ${res.p.toLocaleString("pt-BR")}`, false, "Agora toque em Comparar.");
      } else {
        showScanAIBox("‚ö†Ô∏è N√£o encontrei o pre√ßo", "N√£o consegui identificar o valor com seguran√ßa. Voc√™ pode digitar manualmente.", false, "Tente outra foto com foco no pre√ßo.");
      }
    } catch (e) {
      showScanAIBox("‚ùå Erro ao ler", e.message || String(e), false, "Confira API Key/modelo em Configura√ß√µes.");
      $("scanAiDebug").textContent += "\nERRO: " + (e.message || String(e)) + "\n";
    }
  };

  // settings
  $("btnSettings").onclick = () => openSettings(true);
  $("btnCloseSettings").onclick = () => openSettings(false);
  $("btnSaveSettings").onclick = saveSettings;
  $("btnListModels").onclick = listModelsUI;
  $("btnHealth").onclick = healthCheck;

  $("workerUrl").value = lsGetAny(LS_KEYS.workerUrl, "");
  $("geminiKey").value = lsGetAny(LS_KEYS.geminiKey, "");
  hydrateModelSelect(lsGetAny(LS_KEYS.geminiModel, ""));

  $("settingsModal").addEventListener("click", (e) => {
    if (e.target === $("settingsModal").firstElementChild) openSettings(false);
  });
}

window.addEventListener("beforeunload", () => {
  stopStream(camStream);
  stopStream(scanCamStream);
});

init();
</script>
</body>
</html>
