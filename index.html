<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>TS AI v11.1</title>
<script src="https://cdn.tailwindcss.com"></script>

<style>
.hidden{display:none!important}
body{font-size:20px;background:#f8fafc;font-family:system-ui;-webkit-tap-highlight-color:transparent}
.big-card{background:#fff;border-radius:2rem;padding:1.2rem;border:4px solid #000;box-shadow:8px 8px 0 #000}
video,.preview-img{background:#000;object-fit:cover;border-radius:1.5rem;border:4px solid #000;width:100%;max-height:220px}
.btn-black{background:#000;color:#fff;padding:1rem;border-radius:1.5rem;font-weight:900;text-transform:uppercase;font-style:italic;width:100%}
.item-img{width:60px;height:60px;border-radius:1rem;object-fit:cover;border:2px solid #000}
.compare-img{width:100%;height:120px;border-radius:1rem;object-fit:cover;border:3px solid #000;margin-bottom:10px}
.loading{animation:pulse 1s infinite;opacity:.6;pointer-events:none}
@keyframes pulse{0%,100%{opacity:.6}50%{opacity:1}}
.toast{position:fixed;bottom:20px;left:50%;transform:translateX(-50%);background:#000;color:#fff;
border:3px solid #000;box-shadow:6px 6px 0 #000;border-radius:999px;
padding:10px 16px;font-weight:900;font-size:12px;z-index:9999}
</style>
</head>

<body class="p-4 pb-40">

<header class="mb-4 bg-black text-white p-5 rounded-3xl flex justify-between items-center">
  <div>
    <h1 class="text-2xl font-black italic uppercase">TS AI v11.1</h1>
    <div class="text-xs font-bold mt-1" id="badge">IA: OFF</div>
  </div>
  <div class="flex gap-2">
    <button onclick="openSettings()" class="bg-white text-black px-4 py-2 rounded-xl text-xs font-black border-2 uppercase italic">‚öôÔ∏è</button>
    <button onclick="location.reload()" class="bg-red-600 px-4 py-2 rounded-xl text-xs font-bold border-2 uppercase italic">Reset</button>
  </div>
</header>

<nav class="grid grid-cols-3 gap-2 mb-6">
  <button onclick="go('home')" class="nav">LISTA</button>
  <button onclick="go('add')" class="nav">CADASTRO</button>
  <button onclick="go('scan')" class="nav">SCAN</button>
</nav>

<style>
.nav{background:#fff;border:4px solid #000;padding:1rem;font-weight:900;
border-radius:1.5rem;font-size:10px;box-shadow:4px 4px 0 #000}
</style>

<!-- HOME -->
<div id="s-home" class="tab-sec space-y-4">
  <div id="listCont"></div>
</div>

<!-- ADD -->
<div id="s-add" class="tab-sec hidden">
  <div class="big-card space-y-4 text-center">
    <div id="cam-add" class="hidden space-y-4">
      <video id="v-add" autoplay muted playsinline></video>
      <button onclick="snap('add')" class="btn-black bg-blue-600">üì∏ FOTO</button>
    </div>

    <div id="preview-add" class="hidden space-y-4">
      <img id="img-add" class="preview-img">
      <button onclick="askGemini('add')" id="btn-ia-add" class="btn-black">USAR IA</button>
    </div>

    <button onclick="openCam('add')" class="btn-black border-4 border-dashed">CAPTURAR COM C√ÇMERA</button>

    <input id="pName" placeholder="NOME DO PRODUTO" class="w-full p-4 border-4 border-black rounded-xl font-black uppercase">
    <input id="pPrice" type="number" step="0.01" placeholder="PRE√áO BRASIL"
           class="w-full p-4 border-4 border-black rounded-xl font-black text-4xl text-right">

    <button onclick="saveItem()" class="btn-black text-xl">SALVAR</button>
  </div>
</div>

<!-- SCAN -->
<div id="s-scan" class="tab-sec hidden">
  <div class="big-card space-y-4">
    <div id="cam-scan" class="hidden space-y-4">
      <video id="v-scan" autoplay muted playsinline></video>
      <button onclick="snap('scan')" class="btn-black bg-green-600">üì∏ FOTO</button>
    </div>

    <button onclick="openCam('scan')" class="btn-black border-4 border-dashed">SCAN COM IA</button>

    <input id="scanN" placeholder="ITEM" class="w-full p-4 border-4 border-black rounded-xl font-black uppercase">
    <input id="scanP" type="number" step="0.01" placeholder="PRE√áO EXTERIOR"
           class="w-full p-4 border-4 border-black rounded-xl font-black text-4xl text-blue-600">

    <select id="curr" onchange="rate()" class="w-full p-4 border-4 border-black rounded-xl font-black">
      <option>USD</option><option>EUR</option><option>JPY</option>
    </select>

    <input id="rate" readonly class="w-full p-4 border-4 border-black rounded-xl font-black text-center">

    <button onclick="compare()" class="btn-black text-xl">COMPARAR</button>

    <div id="res" class="hidden p-4 border-4 border-black rounded-2xl font-black text-center"></div>
  </div>
</div>

<!-- SETTINGS -->
<div id="settings" class="hidden fixed inset-0 bg-black/60 flex items-end p-4">
  <div class="bg-white w-full rounded-3xl border-4 border-black p-4 space-y-3">
    <div class="font-black uppercase">API Key Gemini</div>
    <input id="apiKey" type="password" placeholder="COLE SUA API KEY"
           class="w-full p-4 border-4 border-black rounded-xl font-black">
    <button onclick="saveKey()" class="btn-black">SALVAR KEY</button>
    <button onclick="closeSettings()" class="btn-black bg-gray-700">FECHAR</button>
  </div>
</div>

<script>
/* ========= UTIL ========= */
const toast=m=>{const t=document.createElement("div");t.className="toast";t.innerText=m;
document.body.appendChild(t);setTimeout(()=>t.remove(),2200)};
const upper=s=>(s||"").trim().toUpperCase();

/* ========= STATE ========= */
let db=JSON.parse(localStorage.getItem("db")||"[]");
let stream=null,photoB64="",photoURL="";
const LS_KEY="gemini_key";

/* ========= NAV ========= */
function go(t){
 document.querySelectorAll(".tab-sec").forEach(e=>e.classList.add("hidden"));
 document.getElementById("s-"+t).classList.remove("hidden");
 stopCam(); render();
}

/* ========= CAMERA ========= */
async function openCam(m){
 const area=document.getElementById(m==="add"?"cam-add":"cam-scan");
 area.classList.remove("hidden");
 stream=await navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"}});
 document.getElementById(m==="add"?"v-add":"v-scan").srcObject=stream;
}
function stopCam(){if(stream)stream.getTracks().forEach(t=>t.stop());stream=null}
function snap(m){
 const v=document.getElementById(m==="add"?"v-add":"v-scan");
 const c=document.createElement("canvas");
 c.width=v.videoWidth;c.height=v.videoHeight;
 c.getContext("2d").drawImage(v,0,0);
 photoURL=c.toDataURL("image/jpeg",0.8);
 photoB64=photoURL.split(",")[1];
 stopCam();
 if(m==="add"){
   document.getElementById("preview-add").classList.remove("hidden");
   document.getElementById("img-add").src=photoURL;
 }else askGemini("scan");
}

/* ========= GEMINI ========= */
async function askGemini(mode){
 const key=localStorage.getItem(LS_KEY);
 if(!key){alert("Configure a API Key ‚öôÔ∏è");return}

 const btn=mode==="add"?document.getElementById("btn-ia-add"):null;
 if(btn)btn.classList.add("loading");

 try{
 const r=await fetch(
  `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${key}`,
  {method:"POST",headers:{"Content-Type":"application/json"},
   body:JSON.stringify({
    contents:[{parts:[
      {text:'Retorne APENAS {"n":"NOME","p":10.9}'},
      {inlineData:{mimeType:"image/jpeg",data:photoB64}}
    ]}],
    generationConfig:{responseMimeType:"application/json",temperature:0}
   })}
 );
 const j=await r.json();
 if(j.error) throw j.error.message;

 const txt=j.candidates[0].content.parts[0].text;
 const o=JSON.parse(txt);

 if(mode==="add"){
   pName.value=o.n||""; pPrice.value=o.p||0;
 }else{
   scanN.value=o.n||""; scanP.value=o.p||0;
 }
 toast("IA OK");
 }catch(e){
   alert("IA falhou:\n"+e);
 }finally{if(btn)btn.classList.remove("loading")}
}

/* ========= CRUD ========= */
function saveItem(){
 if(!pName.value)return toast("Informe nome");
 db.push({n:upper(pName.value),p:+pPrice.value||0,img:photoURL});
 localStorage.setItem("db",JSON.stringify(db));
 go("home");
}
function render(){
 listCont.innerHTML=db.map(i=>`
 <div class="big-card flex gap-3 items-center">
  ${i.img?`<img src="${i.img}" class="item-img">`:"üì∑"}
  <div><b>${i.n}</b><div>R$ ${i.p.toFixed(2)}</div></div>
 </div>`).join("");
}

/* ========= SCAN ========= */
async function rate(){
 const c=curr.value;
 const r=await fetch("https://open.er-api.com/v6/latest/"+c).then(r=>r.json());
 rate.value=r.rates.BRL.toFixed(2);
}
function compare(){
 const v=scanP.value*rate.value;
 res.classList.remove("hidden");
 res.innerText="R$ "+v.toFixed(2);
}

/* ========= SETTINGS ========= */
function openSettings(){settings.classList.remove("hidden")}
function closeSettings(){settings.classList.add("hidden")}
function saveKey(){
 localStorage.setItem(LS_KEY,apiKey.value.trim());
 badge.innerText="IA: ON";
 toast("Key salva");
 closeSettings();
}

/* ========= INIT ========= */
window.onload=()=>{render();rate()}
</script>
</body>
</html>
